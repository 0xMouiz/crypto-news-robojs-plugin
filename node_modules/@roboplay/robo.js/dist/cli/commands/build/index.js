import { Command } from 'commander';
import { loadManifest, generateManifest } from '../../utils/manifest.js';
import { Logger, logger } from '../../../core/logger.js';
import { loadConfig } from '../../../core/config.js';
import { getProjectSize, printBuildSummary } from '../../utils/build-summary.js';
import plugin from './plugin.js';
import { findCommandDifferences, registerCommands } from '../../utils/commands.js';
import { generateDefaults } from '../../utils/generate-defaults.js';
import { compile } from '../../utils/compiler.js';

const command = new Command("build").description("Builds your bot for production.").argument("[files...]").option("-d --dev", "build for development").option("-f --force", "force register commands").option("-s --silent", "do not print anything").option("-v --verbose", "print more information for debugging").option("-w --watch", "watch for changes and rebuild").action(buildAction).addCommand(plugin);
var build_default = command;
async function buildAction(files, options) {
  const loggerOptions = {
    enabled: !options.silent,
    level: options.verbose ? "debug" : options.dev ? "warn" : "info"
  };
  const logger$1 = options.dev ? new Logger(loggerOptions) : logger(loggerOptions);
  logger$1.info(`Building Robo...`);
  logger$1.debug(`Current working directory:`, process.cwd());
  const startTime = Date.now();
  if (options.watch) {
    logger$1.error(`Watch mode is only available for building plugins.`);
    process.exit(1);
  }
  const config = await loadConfig();
  if (!config) {
    logger$1.warn(`Could not find configuration file.`);
  }
  const compileTime = await compile({ files });
  logger$1.debug(`Compiled in ${compileTime}ms`);
  const generatedFiles = await generateDefaults();
  const oldManifest = await loadManifest();
  const manifestTime = Date.now();
  const manifest = await generateManifest(generatedFiles, "robo");
  logger$1.debug(`Generated manifest in ${Date.now() - manifestTime}ms`);
  if (!options.dev) {
    const sizeStartTime = Date.now();
    const totalSize = await getProjectSize(process.cwd());
    logger$1.debug(`Computed Robo size in ${Date.now() - sizeStartTime}ms`);
    printBuildSummary(manifest, totalSize, startTime, false);
  }
  const oldCommands = oldManifest.commands;
  const newCommands = manifest.commands;
  const addedCommands = findCommandDifferences(oldCommands, newCommands, "added");
  const removedCommands = findCommandDifferences(oldCommands, newCommands, "removed");
  const changedCommands = findCommandDifferences(oldCommands, newCommands, "changed");
  const hasCommandChanges = addedCommands.length > 0 || removedCommands.length > 0 || changedCommands.length > 0;
  const oldContextCommands = { ...oldManifest.context?.message ?? {}, ...oldManifest.context?.user ?? {} };
  const newContextCommands = { ...manifest.context.message, ...manifest.context.user };
  const addedContextCommands = findCommandDifferences(oldContextCommands, newContextCommands, "added");
  const removedContextCommands = findCommandDifferences(oldContextCommands, newContextCommands, "removed");
  const changedContextCommands = findCommandDifferences(oldContextCommands, newContextCommands, "changed");
  const hasContextCommandChanges = addedContextCommands.length > 0 || removedContextCommands.length > 0 || changedContextCommands.length > 0;
  if (options.force) {
    logger$1.warn("Forcefully registering commands.");
  }
  if (options.force || hasCommandChanges || hasContextCommandChanges) {
    await registerCommands(
      options.dev,
      newCommands,
      manifest.context.message,
      manifest.context.user,
      changedCommands,
      addedCommands,
      removedCommands,
      changedContextCommands,
      addedContextCommands,
      removedContextCommands
    );
  }
}

export { buildAction, build_default as default };
